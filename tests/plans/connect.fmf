summary: a-i-b tests running on pre-provisioned machine or VM

environment:
    # Base repository where a-i-b and its dependencies should be installed from
    AIB_BASE_REPO: https://autosd.sig.centos.org/AutoSD-10/nightly/repos/AutoSD/compose/AutoSD/$arch/os/

    # Distribution used inside tests.
    # Available distributions can be listed using `automotive-image-builder list-dist` on the relevant platform.
    AIB_DISTRO: autosd10-sig

    # IP or hostname of a node, where tests will be executed
    NODE: ""

    # SSH key used to authenticate to above NODE
    NODE_SSH_KEY: "~/.ssh/aib-tests"

    # Enable/disable building a-i-b from SRPM
    BUILD_AIB_RPM: no

    # Directory when a-i-b SRPM should exist in order to build it
    AIB_SRPM_DIR: /var/tmp/aib-srpm

    AIB: automotive-image-builder
    AIR: automotive-image-runner
    OUTDIR: /var/tmp/tmt
    BUILDDIR: $OUTDIR/build
    RUNDIR: $OUTDIR/run

provision:
    how: connect
    guest: $NODE
    user: root
    key: $NODE_SSH_KEY

prepare:
    - name: Setup repositories
      how: shell
      script: |
          ./scripts/setup-repos.sh

    - name: Building a-i-b package
      how: shell
      script: |
          ./scripts/rebuild-package.sh

    - name: Install a-i-b
      how: install
      package:
          - automotive-image-builder

    - name: Report a-i-b version
      how: shell
      script: |
         rpm -qi automotive-image-builder

discover:
    how: fmf
    filter: tag:-special

execute:
    how: tmt

report:
    how: junit

finish:
    - name: Cleanup temporary files
      how: shell
      script: |
          ./scripts/cleanup.sh
